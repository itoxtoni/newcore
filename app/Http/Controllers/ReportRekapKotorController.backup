<?php

namespace App\Http\Controllers;

use App\Dao\Enums\Core\NotificationType;
use App\Dao\Models\Rs;
use App\Facades\Model\RsModel;
use App\Facades\Model\UserModel;
use App\Http\Controllers\Core\ReportController;
use App\Jobs\JobRekapKotor;
use Carbon\Carbon;
use Illuminate\Bus\Batch;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Bus;
use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;
use Throwable;

class ReportRekapKotorController extends ReportController
{
    public $data;

    public function __construct(UserModel $model)
    {
        $this->model = $model::getModel();
    }

    public function getData()
    {
        $query = $this->model->dataRepository();

        return $query;
    }

    public function beforeForm()
    {
        self::$share = [
            'rs' => Cache::get('cache_rs')->pluck(RsModel::field_name(), RsModel::field_primary()),
        ];
    }

    private function getQueryKotor($request)
    {
        $query = DB::connection('report')->table('view_rekap_kotor')->where('view_rs_id', $request->rs_id);

        if ($start_date = $request->start_date) {
            $query = $query->where('view_tanggal', '>=', $start_date);
        }

        if ($end_date = $request->end_date) {
            $query = $query->where('view_tanggal', '<=', $end_date);
        }

        return $query->get();
    }

    private function getQueryBersih($request)
    {
        $query = DB::table('view_rekap_bersih')->where('view_rs_id', $request->rs_id);

        if ($start_date = $request->start_date) {
            $bersih_from = Carbon::createFromFormat('Y-m-d', $start_date) ?? false;
            if ($bersih_from) {
                $query = $query->where('view_tanggal', '>=', $bersih_from->addDay(1)->format('Y-m-d'));
            }
        }

        if ($end_date = $request->end_date) {
            $bersih_to = Carbon::createFromFormat('Y-m-d', $end_date) ?? false;
            if ($bersih_to) {
                $query = $query->where('view_tanggal', '<=', $bersih_to->addDay(1)->format('Y-m-d'));
            }
        }

        return $query->get();
    }

    public function getPrint(Request $request)
    {
        set_time_limit(0);

        $query =

        <<<MySQL
        SELECT
        COUNT(*) as total
        FROM view_rekap_kotor
        WHERE view_rs_id = $request->rs_id
            AND view_tanggal >= '$request->start_date'
            AND `view_tanggal` <= '$request->end_date'
        MySQL;

        $total = DB::connection('report')->selectOne($query)->total;
        $numberOfChunks = ceil($total / env('CSV_CHUNK', 1000));

        $name = 'rekap_kotor';

        $name = 'public/files/export/' . Str::snake($name) . '-' . now()->toDateString() . '-' . str_replace(':', '-', now()->toTimeString()) . '.csv';
        $batches = [];

        for ($i = 1; $i <= $numberOfChunks; $i++) {
            $batches[] = new JobRekapKotor($name, $request->all(), $i, env('CSV_CHUNK', 1000), env('CSV_DELIMITER', ','));
        }

        $user_id = auth()->user()->id;

        $batch = Bus::batch($batches)
            ->name('Export Users')
            ->then(function (Batch $batch) use ($name, $user_id) {
                Storage::put($name, file_get_contents($name));

                $notification = new \MBarlow\Megaphone\Types\NewFeature (
                    'Download File Success',
                    'File Ready to download',
                    asset(str_replace('public/', '', $name)),
                    'Download'
                );

                sendNotification($notification, NotificationType::Success, $user_id);

            })
            ->catch(function (Batch $batch, Throwable $e) use ($user_id) {

                Log::error($e->getMessage());

                $notification = new \MBarlow\Megaphone\Types\Important (
                    'Download File Error',
                    $e->getMessage(),
                );

                sendNotification($notification, NotificationType::Error, $user_id);

            })
            ->finally(function (Batch $batch) use ($name) {
                Storage::disk('local')->delete($name);
            })
            ->dispatch();

        if ($request->queue == 'batch') {
            $url = moduleRoute('getCreate', array_merge(['batch' => $batch->id], $request->all()));

            return redirect()->to($url);
        }

        return moduleView(modulePathPrint(), $this->share([
            'data' => $this->data,
        ]));
    }
}
